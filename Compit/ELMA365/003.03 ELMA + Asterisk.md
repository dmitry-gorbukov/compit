
https://chat.deepseek.com/share/kjy02d1s4jtab6wx85

-------------------

Как настроить интеграцию Asterisk с ELMA365. Asterisk поднят и настроен в docker контейнере. Приведи примеры файлов настройки и инструкции по настройке Asterisk и ELMA365/

----------------------------------------------------


Приведу полную инструкцию по интеграции Asterisk с ELMA365. Интеграция позволяет совершать звонки прямо из ELMA365, видеть историю звонков и создавать карточки контактов.

## Архитектура интеграции

```
[Asterisk Docker] <-- AMI --> [ELMA365] <-- REST API --> [Asterisk]
       ↓
   [МТС Транк]
```

## 1. Настройка Asterisk для интеграции

### AMI (Asterisk Manager Interface) конфигурация

**`asterisk/config/manager.conf`:**

```ini
[general]
enabled = yes
port = 5038
bindaddr = 0.0.0.0
timestampevents = yes

[elmauser] ; Пользователь для ELMA365
secret = elma_secret_password_123
deny = 0.0.0.0/0.0.0.0
permit = 172.16.0.0/255.240.0.0 ; Docker network
permit = 192.168.1.0/255.255.255.0 ; Local network
read = all
write = all
eventfilter = !Event: RTCP*
eventfilter = !Event: VarSet
eventfilter = !Event: Cdr
eventfilter = !Event: DTMF
eventfilter = !Event: AGIExec
```

### HTTP конфигурация для REST API

**`asterisk/config/http.conf`:**

```ini
[general]
enabled=yes
bindaddr=0.0.0.0
bindport=8088
prefix=asterisk
enablestatic=yes
sessionlimit=1000
```

### Dialplan для обработки вызовов

**`asterisk/config/extensions.conf` (дополнение):**

```ini
; Контекст для исходящих вызовов из ELMA365
[outbound-elma]
exten => _X!,1,NoOp(=== ИСХОДЯЩИЙ ИЗ ELMA365: ${EXTEN} ===)
 same => n,Set(ELMA_CALL_ID=${CALLERID(num)})
 same => n,Set(CALLERID(num)=${ELMA_OUTBOUND_CID}) ; Установка номера для исходящих
 same => n,Dial(PJSIP/${EXTEN}@mts-trunk,30,m)
 same => n,Hangup()

; Контекст для входящих вызовов с обработкой ELMA
[from-mts-elma]
exten => _X!,1,NoOp(=== ВХОДЯЩИЙ С ОБРАБОТКОЙ ELMA: ${EXTEN} ===)
 same => n,Set(ELMA_CALLER=${CALLERID(num)})
 same => n,Set(ELMA_CALLED=${EXTEN})
 same => n,Answer()
 
 ; Отправка события в ELMA о входящем звонке
 same => n,Set(ELMA_EVENT=incoming_call)
 same => n,AGI(elma_notify.php,${ELMA_EVENT},${ELMA_CALLER},${ELMA_CALLED})
 
 same => n,ExecIf($["${ELMA_ACTION}" = "voicemail"]?Voicemail(1001@default))
 same => n,ExecIf($["${ELMA_ACTION}" = "forward"]?Dial(PJSIP/${ELMA_FORWARD_TO}))
 same => n,Dial(PJSIP/1001&PJSIP/1002,30,m)
 same => n,Hangup()
```

### AGI скрипт для уведомления ELMA

**`asterisk/agi/elma_notify.php`:**

```php
#!/usr/bin/php
<?php
require_once('phpagi.php');

$agi = new AGI();
$event = $argv[1];
$caller = $argv[2];
$called = $argv[3];
$uniqueid = $agi->request['agi_uniqueid'];

// Логирование
$agi->verbose("ELMA Notify: Event=$event, Caller=$caller, Called=$called");

// URL вебхука ELMA365
$webhook_url = "https://your-company.elma365.com/api/webhooks/asterisk";

$payload = [
    'event' => $event,
    'caller' => $caller,
    'called' => $called,
    'uniqueid' => $uniqueid,
    'timestamp' => date('c')
];

// Отправка в ELMA365
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $webhook_url);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
    'Authorization: Bearer your_elma_token_here'
]);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_TIMEOUT, 5);

$response = curl_exec($ch);
$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($http_code == 200) {
    $agi->verbose("ELMA notification sent successfully");
} else {
    $agi->verbose("ELMA notification failed: HTTP $http_code");
}

exit(0);
?>
```

## 2. Обновленный Docker Compose

**`compose-elma.yaml`:**

```yaml
version: '3.8'

services:
  asterisk:
    image: andrius/asterisk:latest
    container_name: asterisk-elma
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./asterisk/config:/etc/asterisk
      - ./asterisk/logs:/var/log/asterisk
      - ./asterisk/agi:/var/lib/asterisk/agi-bin
      - ./asterisk/recordings:/var/spool/asterisk/monitor
    environment:
      - TZ=Europe/Moscow
    cap_add:
      - NET_ADMIN
    ports:
      - "5038:5038"    # AMI порт
      - "8088:8088"    # HTTP API порт
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "10000-10100:10000-10100/udp"

  # Контейнер для AGI скриптов с PHP
  asterisk-agi:
    image: php:8.1-cli
    container_name: asterisk-agi
    restart: unless-stopped
    volumes:
      - ./asterisk/agi:/var/www/agi
    working_dir: /var/www/agi
    command: tail -f /dev/null
```

## 3. Настройка в ELMA365

### Вебхук для приема событий от Asterisk

В ELMA365 создайте вебхук в разделе "Администрирование" → "Интеграции":

**URL вебхука:** `https://your-company.elma365.com/api/webhooks/asterisk`

### Бизнес-процесс для обработки звонков

Создайте бизнес-процесс в ELMA365:

**Триггер:** "Веб-запрос" 
**Схема процесса:**

```json
{
  "name": "Обработка телефонных звонков",
  "variables": {
    "event": "Тип события",
    "caller": "Номер звонящего", 
    "called": "Номер назначения",
    "uniqueid": "ID звонка",
    "timestamp": "Время звонка"
  },
  "steps": [
    {
      "type": "condition",
      "condition": "{{event}} == 'incoming_call'",
      "steps": [
        {
          "type": "create_object",
          "object_type": "contact",
          "fields": {
            "phone": "{{caller}}",
            "last_call": "{{timestamp}}"
          }
        },
        {
          "type": "notification", 
          "message": "Входящий звонок от {{caller}}"
        }
      ]
    }
  ]
}
```

### REST API для исходящих звонков

В ELMA365 создайте HTTP-запросы для инициации звонков:

**Пример кода в ELMA:**

```javascript
// Функция для совершения исходящего звонка
async function makeCall(phoneNumber, internalUser) {
    const response = await fetch('http://your-asterisk-server:8088/ari/channels', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            endpoint: `PJSIP/${internalUser}`,
            extension: phoneNumber,
            context: 'outbound-elma',
            priority: 1,
            app: 'stasis',
            appArgs: 'call'
        })
    });
    return await response.json();
}

// Функция для получения истории звонков
async function getCallHistory(dateFrom, dateTo) {
    const response = await fetch('http://your-asterisk-server:8088/ari/cdr', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    });
    return await response.json();
}
```

## 4. Дополнительные конфигурационные файлы

### ARI (Asterisk REST Interface) конфигурация

**`asterisk/config/ari.conf`:**

```ini
[general]
enabled = yes
pretty = yes
allowed_origins = *
auth_realm = Asterisk REST Interface

[elmauser]
type = user
read_only = no
password = elma_ari_password_123
password_format = plain
```

### CDR конфигурация для учета звонков

**`asterisk/config/cdr.conf`:**

```ini
[general]
enable=yes

[elma-cdr]
usegmtime=yes 
loguniqueid=yes
loguserfield=yes
table=cdr
; Интеграция с ELMA через HTTP
; http://your-elma-server/api/cdr
```

## 5. Скрипты для двусторонней синхронизации

### Скрипт синхронизации контактов

**`sync_contacts.py`:**

```python
#!/usr/bin/env python3
import requests
import json
import mysql.connector

# Конфигурация
ELMA_API_URL = "https://your-company.elma365.com/api/v1"
ELMA_TOKEN = "your_elma_token"
ASTERISK_DB_HOST = "localhost"
ASTERISK_DB_USER = "asterisk"
ASTERISK_DB_PASS = "asterisk_password"

def sync_contacts_to_elma():
    # Получение контактов из Asterisk (если используется база)
    conn = mysql.connector.connect(
        host=ASTERISK_DB_HOST,
        user=ASTERISK_DB_USER,
        password=ASTERISK_DB_PASS,
        database="asterisk"
    )
    
    cursor = conn.cursor()
    cursor.execute("SELECT name, number FROM phonebook")
    
    for name, number in cursor:
        # Создание контакта в ELMA
        contact_data = {
            "name": name,
            "phone": number,
            "source": "asterisk"
        }
        
        response = requests.post(
            f"{ELMA_API_URL}/contacts",
            json=contact_data,
            headers={"Authorization": f"Bearer {ELMA_TOKEN}"}
        )
        
        if response.status_code == 200:
            print(f"Contact {name} synced successfully")
    
    cursor.close()
    conn.close()

if __name__ == "__main__":
    sync_contacts_to_elma()
```

## 6. Инструкция по настройке

### Настройка Asterisk:

1. **Разверните контейнеры:**
   ```bash
   docker-compose -f compose-elma.yaml up -d
   ```

2. **Настройте AGI скрипты:**
   ```bash
   chmod +x asterisk/agi/elma_notify.php
   docker exec asterisk-elma apt-get update && apt-get install -y php-cli curl
   ```

3. **Проверьте AMI подключение:**
   ```bash
   telnet localhost 5038
   ```

### Настройка ELMA365:

1. **Создайте вебхук** для приема событий от Asterisk
2. **Настройте бизнес-процесс** для обработки звонков
3. **Создайте HTTP-запросы** для управления звонками
4. **Настройте интерфейс** с кнопками для звонков

### Тестирование интеграции:

1. **Входящий звонок:** Позвоните на номер МТС - в ELMA должна создаться карточка
2. **Исходящий звонок:** Из ELMA нажмите "Позвонить" - должен инициироваться звонок
3. **История звонков:** Проверьте синхронизацию CDR записей

## 7. Безопасность

- Используйте HTTPS для вебхуков
- Ограничьте доступ к AMI порту по IP
- Регулярно обновляйте токены доступа
- Настройте firewall правила

Такая интеграция позволит полноценно связать Asterisk с ELMA365 для автоматизации телефонии и CRM-процессов.
<!--stackedit_data:
eyJoaXN0b3J5IjpbODEyMjE3MjU3XX0=
-->