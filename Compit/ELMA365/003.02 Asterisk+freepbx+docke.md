
https://chat.deepseek.com/share/eznq4vl5eba36ebqn6


Можно ли сервер Asterisk развернуть в docker контейнере с docker hub/ Приведи пример compose.yaml файла. а так же пример интеграции этого контейнера Asterisk с МТС облачной АТС.

--------------

Да, **Asterisk можно развернуть в Docker-контейнере**. Это популярный подход для тестирования и развертывания. Приведу полный пример.

## Docker Compose файл

**`compose.yaml`:**

```yaml
version: '3.8'

services:
  asterisk:
    image: andrius/asterisk:latest
    container_name: asterisk-mts
    restart: unless-stopped
    privileged: true
    network_mode: host
    # Альтернатива network_mode: host - проброс портов
    # ports:
    #   - "5060:5060/udp"
    #   - "5060:5060/tcp"
    #   - "10000-10100:10000-10100/udp"  # RTP порты
    #   - "5038:5038"  # AMI порт
    volumes:
      - ./asterisk/config:/etc/asterisk
      - ./asterisk/logs:/var/log/asterisk
      - ./asterisk/recordings:/var/spool/asterisk/monitor
      - /dev/snd:/dev/snd  # Для аудио устройств
    environment:
      - TZ=Europe/Moscow
    cap_add:
      - SYS_PTRACE
    stdin_open: true
    tty: true

  # Опционально: Веб-интерфейс FreePBX для упрощения управления
  freepbx:
    image: andrius/freepbx:latest
    container_name: freepbx-mts
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./freepbx/config:/etc/asterisk
      - ./freepbx/data:/var/lib/asterisk
      - ./freepbx/logs:/var/log/asterisk
    depends_on:
      - asterisk
    environment:
      - TZ=Europe/Moscow
```

## Альтернативный вариант с официальным образом

**`compose-alternative.yaml`:**

```yaml
version: '3.8'

services:
  asterisk:
    image: asterisk/asterisk:latest
    container_name: asterisk-mts
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./asterisk/config:/etc/asterisk
      - ./asterisk/logs:/var/log/asterisk
      - ./asterisk/spool:/var/spool/asterisk
      - /dev/snd:/dev/snd
    environment:
      - TZ=Europe/Moscow
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        asterisk -f -vvvg -c &
        sleep 10 &&
        tail -f /var/log/asterisk/messages
      "
```

## Полная настройка интеграции с МТС

### 1. Подготовка структуры файлов

```bash
mkdir -p asterisk/{config,logs,recordings}
mkdir -p freepbx/{config,data,logs}
```

### 2. Конфигурационные файлы для Asterisk

**`asterisk/config/pjsip.conf`:**

```ini
; Основной транспорт
[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060

; Регистрация в МТС
[mts-registration]
type=registration
outbound_auth=mts-auth
server_uri=sip:sip.mts.by
client_uri=sip:your_username@sip.mts.by
retry_interval=60

; Аутентификация МТС
[mts-auth]
type=auth
auth_type=userpass
password=your_password_from_mts
username=your_username_from_mts

; Транк МТС для исходящих
[mts-trunk]
type=endpoint
context=from-mts
disallow=all
allow=ulaw,alaw,g729
from_user=your_username
auth=mts-auth
aors=mts-aor
direct_media=no
force_rport=yes
rewrite_contact=yes
transport=transport-udp

[mts-aor]
type=aor
contact=sip:sip.mts.by
qualify_frequency=60

; Внутренние пользователи
[1001]
type=endpoint
context=internal
disallow=all
allow=ulaw,alaw
auth=auth1001
aors=1001
direct_media=no

[auth1001]
type=auth
auth_type=userpass
password=user1001pass
username=1001

[1001]
type=aor
max_contacts=1

[1002]
type=endpoint
context=internal
disallow=all
allow=ulaw,alaw
auth=auth1002
aors=1002
direct_media=no

[auth1002]
type=auth
auth_type=userpass
password=user1002pass
username=1002

[1002]
type=aor
max_contacts=1
```

**`asterisk/config/extensions.conf`:**

```ini
[general]
static=yes
writeprotect=no
clearglobalvars=no

; Контекст для входящих вызовов от МТС
[from-mts]
exten => _X!,1,NoOp(=== ВХОДЯЩИЙ ВЫЗОВ ОТ МТС: ${EXTEN} ===)
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Answer()
 same => n,Playback(hello)
 same => n,Set(TIMEOUT(absolute)=120)
 
 ; Пример IVR меню
 same => n,Background(ivr-welcome)
 same => n,Read(choice,ivr-main-menu,1,,2,3)
 
exten => 1,1,NoOp(Перевод в отдел продаж)
 same => n,Goto(sales,1)
 
exten => 2,1,NoOp(Перевод в техподдержку)
 same => n,Goto(support,1)
 
exten => i,1,NoOp(Неверный выбор)
 same => n,Playback(invalid)
 same => n,Goto(from-mts,${EXTEN},1)
 
exten => t,1,NoOp(Таймаут)
 same => n,Playback(goodbye)
 same => n,Hangup()

[sales]
exten => 1,1,NoOp(Отдел продаж)
 same => n,Dial(PJSIP/1001,20,m)
 same => n,Voicemail(1001@default)
 same => n,Hangup()

[support]
exten => 1,1,NoOp(Техподдержка)
 same => n,Dial(PJSIP/1002,20,m)
 same => n,Voicemail(1002@default)
 same => n,Hangup()

; Контекст для внутренних вызовов
[internal]
exten => 1001,1,Dial(PJSIP/1001,20)
exten => 1002,1,Dial(PJSIP/1002,20)

; Исходящие вызовы через МТС
[outbound-mts]
; Городские номера (префикс 9)
exten => _925XXXXXXX,1,NoOp(Исходящий на городской: ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN:1}@mts-trunk,30)
 same => n,Hangup()

; Мобильные номера
exten => _929XXXXXXXXX,1,NoOp(Исходящий на мобильный: ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN:1}@mts-trunk,30)
 same => n,Hangup()

; Международные вызовы
exten => _900.,1,NoOp(Международный вызов: ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN:1}@mts-trunk,30)
 same => n,Hangup()
```

**`asterisk/config/voicemail.conf`:**

```ini
[general]
format=wav49|wav
serveremail=asterisk@yourcompany.by
attach=yes
skipms=3000
maxsilence=10
maxlogins=3
emaildateformat=%A, %B %d, %Y at %r
pagerdateformat=%A, %B %d, %Y at %r
sendvoicemail=yes

[default]
1001 => 1234,Иван Иванов,ivan@yourcompany.by
1002 => 5678,Петр Петров,petr@yourcompany.by
```

**`asterisk/config/rtp.conf`:**

```ini
[general]
rtpstart=10000
rtpend=10100
```

### 3. Запуск и настройка

```bash
# Запуск контейнеров
docker-compose up -d

# Просмотр логов
docker-compose logs -f asterisk

# Вход в контейнер для отладки
docker exec -it asterisk-mts bash

# В CLI Asterisk (из контейнера)
asterisk -rvvv
```

### 4. Команды для проверки в CLI Asterisk

```bash
# Проверить регистрацию в МТС
pjsip show registrations

# Показать endpoints
pjsip show endpoints

# Показать транки
pjsip show transports

# Проверить статус каналов
core show channels

# Перезагрузить конфигурацию
core reload
```

### 5. Настройка SIP-клиентов

Для внутренних номеров настройте SIP-клиенты:

**Номер 1001:**
- Логин: `1001`
- Пароль: `user1001pass`
- Сервер: IP вашего Docker-хоста
- Порт: `5060`

**Номер 1002:**
- Логин: `1002` 
- Пароль: `user1002pass`
- Сервер: IP вашего Docker-хоста
- Порт: `5060`

### 6. Dockerfile для кастомного образа (опционально)

**`Dockerfile`:**

```dockerfile
FROM asterisk/asterisk:latest

# Установка дополнительных кодеков
RUN apt-get update && apt-get install -y \
    asterisk-codec-g729 \
    asterisk-codec-opus \
    && rm -rf /var/lib/apt/lists/*

# Копирование конфигураций
COPY config/ /etc/asterisk/

# Разрешения
RUN chown -R asterisk:asterisk /etc/asterisk

EXPOSE 5060/udp 5060/tcp 10000-10100/udp

CMD ["asterisk", "-f", "-vvvg", "-c"]
```

## Важные замечания для Docker

1. **Сетевой режим**: `network_mode: host` упрощает настройку, но менее безопасен
2. **Порты**: Убедитесь, что порты 5060 (UDP/TCP) и RTP-диапазон открыты
3. **NAT**: Если хост за NAT, потребуется дополнительная настройка STUN/RTP
4. **Персистентность**: Конфиги вынесены в volumes для сохранения данных
5. **Производительность**: Для продакшена настройте лимиты ресурсов

Такая конфигурация позволит быстро развернуть Asterisk в Docker с полной интеграцией с виртуальной АТС МТС.
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTExMjI5NzkyMF19
-->