
Проблема в настройках Joplin! Он блокирует запросы из-за несоответствия `APP_BASE_URL`. Давайте исправим все файлы.

## 1. Обновленный Traefik compose.yml

`/opt/docker-services/traefik/compose.yml`:
```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - web

networks:
  web:
    external: true
```

## 2. Исправленный Joplin compose.yml

`/opt/docker-services/joplin/compose.yml`:
```yaml
version: '3.8'

services:
  joplin-db:
    image: postgres:13
    container_name: joplin-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: joplin_user
      POSTGRES_PASSWORD: joplin_password_123
      POSTGRES_DB: joplin_db
    volumes:
      - ./db:/var/lib/postgresql/data
    networks:
      - joplin-net

  joplin-server:
    image: joplin/server:3.4.3
    container_name: joplin-server
    restart: unless-stopped
    environment:
      APP_PORT: 22300
      APP_BASE_URL: http://joplin.localhost
      DB_CLIENT: pg
      POSTGRES_DATABASE: joplin_db
      POSTGRES_USER: joplin_user
      POSTGRES_PASSWORD: joplin_password_123
      POSTGRES_PORT: 5432
      POSTGRES_HOST: joplin-db
    ports:
      - "22300:22300"
    volumes:
      - ./data:/var/lib/joplin
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.joplin.rule=Host(`joplin.localhost`)"
      - "traefik.http.routers.joplin.entrypoints=web"
      - "traefik.http.services.joplin.loadbalancer.server.port=22300"
    depends_on:
      - joplin-db
    networks:
      - web
      - joplin-net

networks:
  web:
    external: true
  joplin-net:
    external: false
```

## 3. Обновленные systemd сервисы

`/etc/systemd/system/traefik.service`:
```ini
[Unit]
Description=Traefik Reverse Proxy
Documentation=https://traefik.io
After=docker.service
Requires=docker.service
Wants=docker.socket

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/docker-services/traefik
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
ExecReload=/usr/bin/docker compose restart
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
```

`/etc/systemd/system/joplin.service`:
```ini
[Unit]
Description=Joplin Server
After=docker.service traefik.service
Requires=docker.service
Wants=traefik.service docker.socket

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/docker-services/joplin
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
ExecReload=/usr/bin/docker compose restart
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
```

## 4. Проверка и обновление hosts файла

```bash
# Проверим hosts файл
cat /etc/hosts | grep joplin.localhost

# Если записи нет, добавим
echo "127.0.0.1 joplin.localhost" | sudo tee -a /etc/hosts
```

## 5. Процесс перезапуска

```bash
# Останавливаем сервисы
sudo systemctl stop joplin.service
sudo systemctl stop traefik.service

# Удаляем старые контейнеры
cd /opt/docker-services/joplin
docker compose down -v

cd /opt/docker-services/traefik
docker compose down

# Удаляем старые данные Joplin (если нужно сбросить)
sudo rm -rf /opt/docker-services/joplin/data
sudo rm -rf /opt/docker-services/joplin/db

# Создаем новые директории
mkdir -p /opt/docker-services/joplin/data
mkdir -p /opt/docker-services/joplin/db

# Перезагружаем systemd
sudo systemctl daemon-reload

# Запускаем сервисы
sudo systemctl start traefik.service
sudo systemctl start joplin.service

# Даем время на запуск
sleep 20

# Проверяем статус
sudo systemctl status joplin.service traefik.service

# Проверяем контейнеры
docker ps | grep -E "(joplin|traefik)"

# Проверяем логи Joplin
docker logs joplin-server --tail 20
```

## 6. Проверка доступности

```bash
# Проверяем прямой доступ (должен работать)
curl -v http://localhost:22300/api/ping

# Проверяем через Traefik
curl -v http://joplin.localhost/api/ping

# Проверяем в браузере
curl http://joplin.localhost/
```

## 7. Если всё еще есть проблемы

Попробуем альтернативную конфигурацию с правильными настройками CORS:

`/opt/docker-services/joplin/compose.yml` (альтернативная версия):
```yaml
version: '3.8'

services:
  joplin-db:
    image: postgres:13
    container_name: joplin-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: joplin
      POSTGRES_PASSWORD: joplin123456
      POSTGRES_DB: joplin
    volumes:
      - ./db:/var/lib/postgresql/data
    networks:
      - joplin-net

  joplin-server:
    image: joplin/server:latest
    container_name: joplin-server
    restart: unless-stopped
    environment:
      APP_PORT: 22300
      APP_BASE_URL: http://joplin.localhost
      DB_CLIENT: postgres
      POSTGRES_DATABASE: joplin
      POSTGRES_USER: joplin
      POSTGRES_PASSWORD: joplin123456
      POSTGRES_PORT: 5432
      POSTGRES_HOST: joplin-db
      # Дополнительные настройки для CORS
      COOKIE_SECURE: "false"
      ALLOWED_ORIGINS: "http://joplin.localhost,http://localhost:22300"
    ports:
      - "22300:22300"
    volumes:
      - ./data:/var/lib/joplin
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.joplin.rule=Host(`joplin.localhost`)"
      - "traefik.http.routers.joplin.entrypoints=web"
      - "traefik.http.services.joplin.loadbalancer.server.port=22300"
    depends_on:
      - joplin-db
    networks:
      - web
      - joplin-net

networks:
  web:
    external: true
  joplin-net:
    external: false
```

## 8. Проверка сети

```bash
# Проверим, что контейнеры в нужных сетях
docker network inspect web

# Создаем сеть если её нет
docker network create web
```

**Выполните процесс перезапуска из пункта 5** - это должно решить проблему с "Invalid origin".
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEwMjE4MzUwNjgsLTIwNjAzNTU4ODJdfQ
==
-->